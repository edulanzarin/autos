#!/bin/bash

# ===========================
# Autos - Script de Atualiza√ß√£o
# ===========================
# Atualiza o reposit√≥rio Autos de forma segura, com backup autom√°tico,
# logs detalhados e verifica√ß√£o de conflitos.
# ===========================

# Configura√ß√µes
INSTALL_DIR=$(dirname "$(realpath "$0")")
BACKUP_DIR="$HOME/autos-backup"
LOG_FILE="$INSTALL_DIR/update.log"

# Fun√ß√£o para logs
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Verifica se √© um reposit√≥rio
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    log "‚ùå Erro: N√£o √© um reposit√≥rio Git"
    exit 1
fi

# Configura upstream se n√£o existir
if [ -z "$(git config --get branch.main.remote)" ]; then
    log "üîó Configurando upstream para a branch main..."
    git branch --set-upstream-to=origin/main main || {
        log "‚ùå Falha ao configurar upstream. Execute manualmente:";
        log "git branch --set-upstream-to=origin/main main";
        exit 1;
    }
fi

# Modo de apenas verificar
if [ "$1" == "--check-only" ]; then
    git fetch origin >/dev/null 2>&1
    LOCAL=$(git rev-parse @)
    REMOTE=$(git rev-parse @{u})
    [ "$LOCAL" != "$REMOTE" ] && echo "[AUTOS] Atualiza√ß√£o dispon√≠vel! Execute: autos core/update"
    exit 0
fi

# L√≥gica principal
log "üîÑ Buscando atualiza√ß√µes..."
git fetch origin

LOCAL=$(git rev-parse @)
REMOTE=$(git rev-parse @{u})
BASE=$(git merge-base @ @{u})

if [ "$LOCAL" = "$REMOTE" ]; then
    log "‚úÖ Voc√™ est√° na vers√£o mais recente."
    exit 0
elif [ "$LOCAL" = "$BASE" ]; then
    # Backup
    BACKUP_NAME="autos-$(date +%Y%m%d%H%M%S)"
    log "üíæ Backup: $BACKUP_DIR/$BACKUP_NAME"
    mkdir -p "$BACKUP_DIR"
    cp -r "$INSTALL_DIR" "$BACKUP_DIR/$BACKUP_NAME"
    
    # Atualiza√ß√£o
    log "‚¨áÔ∏è Baixando atualiza√ß√µes..."
    if git pull --rebase; then
        log "üîë Aplicando permiss√µes..."
        find "$INSTALL_DIR" -type f \( -name "*.sh" -o -name "autos" \) -exec chmod +x {} \;
        log "‚úÖ Atualiza√ß√£o conclu√≠da!"
    else
        log "‚ùå Falha na atualiza√ß√£o. Veja o log: $LOG_FILE"
        exit 1
    fi
else
    log "‚ö†Ô∏è Conflitos detectados! Resolva manualmente:"
    log "1. git status"
    log "2. Edite os arquivos com conflitos"
    log "3. git add . && git rebase --continue"
    exit 1
fi